<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NUSA EARNING</title>
  <style>
    body {
      margin: 0; font-family: 'Poppins', sans-serif;
      background: #0d1117; color: #fff; text-align: center;
    }
    h1 { color: #00f5d4; margin: 20px 0; }
    .card {
      background: #161b22; border-radius: 15px;
      padding: 20px; margin: 20px auto; width: 90%;
      max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }
    input {
      width: 90%; padding: 12px; margin: 10px 0;
      border-radius: 10px; border: none;
    }
    button {
      padding: 12px 20px; border: none;
      border-radius: 12px; background: linear-gradient(45deg, #00f5d4, #00bbf9);
      color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    button:disabled { background: #555; cursor: not-allowed; }
    #splash {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: #0d1117; display: flex; align-items:center; justify-content:center;
      flex-direction: column; z-index: 9999;
    }
    .loader {
      width: 80%; height: 6px; background: #333;
      margin-top: 20px; border-radius: 3px; overflow: hidden;
    }
    .loader div {
      width: 0; height: 100%; background: #00f5d4;
      animation: load 2s forwards;
    }
    @keyframes load { to { width: 100%; } }
    .saldo { font-size: 20px; margin: 10px 0; font-weight: bold; }
    .notif {
      background: #ff4444; padding: 10px; border-radius: 10px; margin: 20px;
    }
  </style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <h1>NT</h1>
  <div class="loader"><div></div></div>
  <p>Memuat NUSA EARNING...</p>
</div>

<!-- AUTH -->
<div id="auth" class="card" style="display:none;">
  <h1>NUSATASK</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Kata Sandi (min 6)">
  <button onclick="register()">Daftar & Masuk</button>
</div>

<!-- NOTIF -->
<div id="notif" class="card" style="display:none;">
  <div class="notif">
    ‚ö†Ô∏è Dilarang melakukan kecurangan! Akun akan dibanned permanen.
  </div>
  <button onclick="goDashboard()">Saya Mengerti</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;">
  <h1>NUSA EARNING</h1>
  <div class="saldo">Saldo: <span id="saldo">0</span> üí∞</div>
  <button id="earnBtn" onclick="earn()">Hasilkan</button>
  <p id="cooldown"></p>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdlvPMWThdEUk2D92Tg_mQSHbGO4LG2AE",
  authDomain: "nusa-7a52a.firebaseapp.com",
  databaseURL: "https://nusa-7a52a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nusa-7a52a",
  storageBucket: "nusa-7a52a.firebasestorage.app",
  messagingSenderId: "72016839114",
  appId: "1:72016839114:web:0bc8978a826619f7ad8f33",
  measurementId: "G-HBZN4WGKWX"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let userId = null;
let cooldownActive = false;
let maxDaily = 20;
let todayCount = 0;

// --- SPLASH ---
window.onload = () => {
  setTimeout(()=>{
    document.getElementById("splash").style.display="none";
    auth.onAuthStateChanged(user=>{
      if(user){
        userId=user.uid;
        checkReset();
        listenSaldo();
        document.getElementById("notif").style.display="block";
      }else{
        document.getElementById("auth").style.display="block";
      }
    });
  },2500);
};

// --- AUTH ---
function register(){
  let email=document.getElementById("email").value;
  let pass=document.getElementById("password").value;
  auth.createUserWithEmailAndPassword(email,pass)
  .catch(e=>{
    auth.signInWithEmailAndPassword(email,pass);
  });
}

// --- NOTIF ke Dashboard ---
function goDashboard(){
  document.getElementById("notif").style.display="none";
  document.getElementById("dashboard").style.display="block";
}

// --- LISTEN SALDO ---
function listenSaldo(){
  db.ref("users/"+userId+"/saldo").on("value",snap=>{
    let saldo=snap.val()||0;
    document.getElementById("saldo").innerText=saldo;
  });
  db.ref("users/"+userId+"/todayCount").on("value",snap=>{
    todayCount=snap.val()||0;
  });
}

// --- EARN ---
async function earn(){
  if(cooldownActive) return;
  if(todayCount>=maxDaily){
    alert("Limit harian tercapai. Tunggu reset jam 6 pagi.");
    return;
  }
  cooldownActive=true;
  todayCount++;
  db.ref("users/"+userId+"/todayCount").set(todayCount);

  playMonetag().then(()=>{
    // tambah saldo setelah iklan selesai
    db.ref("users/"+userId+"/saldo").transaction(s=> (s||0)+100 );
    startCooldown();
  });
}

// --- COOLDOWN ---
function startCooldown(){
  let sec=180;
  const btn=document.getElementById("earnBtn");
  btn.disabled=true;
  let cd=document.getElementById("cooldown");
  let interval=setInterval(()=>{
    sec--;
    cd.innerText="Cooldown: "+sec+"s";
    if(sec<=0){ clearInterval(interval); btn.disabled=false; cd.innerText=""; cooldownActive=false; }
  },1000);
}

// --- RESET JAM 6 PAGI ---
function checkReset(){
  const now=new Date();
  const reset=new Date();
  reset.setHours(6,0,0,0);
  if(now>reset) reset.setDate(reset.getDate()+1);
  const ms=reset-now;
  setTimeout(()=>{
    todayCount=0;
    db.ref("users/"+userId+"/todayCount").set(0);
    checkReset();
  },ms);
}

// --- Monetag ---
function loadScriptOnce(src, attrs = {}) {
  if(document.querySelector(`script[data-src-fingerprint="${src}"]`)) return Promise.resolve();
  return new Promise((res,rej)=>{
    const s=document.createElement("script");
    s.src=src; s.async=true;
    for(const k in attrs) s.setAttribute(k, attrs[k]);
    s.setAttribute("data-src-fingerprint",src);
    s.onload=()=>res(); s.onerror=e=>rej(e);
    document.body.appendChild(s);
  });
}
function simulateAd(sec=8,label="Iklan (simulasi)"){
  return new Promise(r=>{
    alert(label+" berjalan "+sec+"s (simulasi)");
    setTimeout(()=>r(),sec*1000);
  });
}
async function playMonetag(){
  try{
    await loadScriptOnce("//libtl.com/sdk.js",{"data-zone":"9779635","data-sdk":"show_9779635"});
    if(typeof window.show_9779635==="function"){
      const res=window.show_9779635();
      if(res && typeof res.then==="function"){ await res; }
      else{ await new Promise(r=>setTimeout(r,3000)); }
    }else{
      await simulateAd(9,"Simulasi Monetag");
    }
  }catch(e){
    console.warn("Gagal muat Monetag",e);
    await simulateAd(9,"Simulasi Monetag");
  }
}
</script>
</body>
</html>