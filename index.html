<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NUSATASK ‚Äî NT (Final)</title>

  <!-- Firebase compat SDKs (use compat to keep simple API) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Monetag Ad Script (you provided) -->
  <script src='//libtl.com/sdk.js' data-zone='9779635' data-sdk='show_9779635'></script>

  <!-- Nice font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#06070a; --card:#0f1720; --muted:#9fb3c9;
      --accent1:#6ee7b7; --accent2:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#020305,#081019);color:#eaf6ff;min-height:100vh}
    .center{display:flex;align-items:center;justify-content:center}
    /* Loading / Logo */
    #loading{height:100vh;flex-direction:column;gap:18px}
    .logoCircle{width:84px;height:84px;border-radius:20px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#012; font-size:28px; box-shadow:0 12px 40px rgba(0,120,255,0.12)}
    .brandTitle{font-size:28px;font-weight:800;letter-spacing:2px}
    .loadingBar{width:320px;height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .loadingBar > .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .8s cubic-bezier(.22,.9,.34,1)}
    /* App */
    .appWrap{max-width:920px;margin:36px auto;padding:22px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .balanceBox{background:rgba(255,255,255,0.03);padding:10px 14px;border-radius:14px;font-weight:700;box-shadow:0 8px 24px rgba(2,6,12,0.6)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:20px;box-shadow:0 12px 40px rgba(2,6,12,0.5)}
    .muted{color:var(--muted);font-size:13px}
    .warning{background:#3b0f10;color:#ffd6d6;padding:12px;border-radius:10px;margin:12px 0}
    /* premium button */
    .earnBtn{display:inline-block;padding:18px 36px;border-radius:999px;border:0;font-weight:800;font-size:18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#032;cursor:pointer;box-shadow:0 10px 30px rgba(6,120,180,0.18);transition:transform .18s}
    .earnBtn:active{transform:scale(.98)}
    .earnBtn[disabled]{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .progress{height:14px;width:100%;background:rgba(255,255,255,0.04);border-radius:999px;margin-top:18px;overflow:hidden}
    .progress > .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .35s ease}
    .small{font-size:13px;color:var(--muted)}
    /* form */
    .authCard{max-width:420px;margin:32px auto;padding:26px;border-radius:14px;background:rgba(255,255,255,0.02)}
    input{width:100%;padding:12px;border-radius:10px;border:0;margin:8px 0;background:rgba(255,255,255,0.02);color:#eaf6ff;font-size:15px}
    .pillBtn{padding:10px 14px;border-radius:999px;border:0;background:rgba(255,255,255,0.03);color:#eaf6ff;cursor:pointer}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media (max-width:760px){ .appWrap{padding:12px} .logoCircle{width:64px;height:64px} }
  </style>
</head>
<body>

  <!-- LOADING -->
  <div id="loading" class="center" style="flex-direction:column">
    <div class="logoCircle">NT</div>
    <div class="brandTitle">NUSATASK</div>
    <div class="loadingBar"><div id="fill" class="fill"></div></div>
  </div>

  <!-- AUTH -->
  <div id="auth" style="display:none">
    <div class="authCard">
      <div style="display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px">
        <div class="logoCircle" style="width:56px;height:56px;font-size:20px">NT</div>
        <div style="text-align:left">
          <div style="font-weight:800">NUSATASK</div>
          <div class="small">Masuk atau daftar untuk mulai mendapatkan</div>
        </div>
      </div>

      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password (min 6)" />
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="pillBtn" id="btn-login">Masuk</button>
        <button class="pillBtn" id="btn-register">Daftar</button>
      </div>
      <div class="footer">Dengan mendaftar, Anda setuju pada Syarat & Ketentuan NUSATASK</div>
    </div>
  </div>

  <!-- WARNING (5s) -->
  <div id="warning" style="display:none" class="center">
    <div class="authCard" style="max-width:520px">
      <h3 style="margin:0">‚ö†Ô∏è Peringatan</h3>
      <p class="small" style="margin:10px 0">Segala bentuk hack / nuyul / manipulasi data akan menyebabkan banned otomatis. Lanjutkan hanya jika setuju.</p>
      <button class="earnBtn" id="continueBtn" disabled>Continue (5)</button>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="appWrap">
      <div class="topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logoCircle" style="width:56px;height:56px;font-size:20px">NT</div>
          <div style="text-align:left">
            <div style="font-weight:800;font-size:18px">NUSATASK</div>
            <div class="small">Premium earning ‚Äî Monetag</div>
          </div>
        </div>
        <div class="balanceBox" id="balanceBox">üí∞ <span id="balance">0</span></div>
      </div>

      <div class="card">
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
          <div class="small muted">Tonton iklan untuk mendapatkan reward. Cooldown 3 menit | Max 20x per hari</div>
          <button class="earnBtn" id="earnBtn">MENGHASILKAN</button>
          <div class="progress" style="max-width:420px"><div class="bar" id="progBar"></div></div>
          <div class="small" id="statusText">Sisa: 20 / hari</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======================= CONFIG ======================= */
/* Firebase config (you provided) */
const firebaseConfig = {
  apiKey: "AIzaSyDdlvPMWThdEUk2D92Tg_mQSHbGO4LG2AE",
  authDomain: "nusa-7a52a.firebaseapp.com",
  databaseURL: "https://nusa-7a52a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nusa-7a52a",
  storageBucket: "nusa-7a52a.firebasestorage.app",
  messagingSenderId: "72016839114",
  appId: "1:72016839114:web:0bc8978a826619f7ad8f33",
  measurementId: "G-HBZN4WGKWX"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const rtdb = firebase.database();

/* App constants */
const COOLDOWN_MS = 3 * 60 * 1000; // 3 menit
const DAILY_MAX = 20;              // 20x per hari
const REWARD = 10;                // reward per iklan

/* Device ID & IP */
const deviceId = btoa(navigator.userAgent + '|' + screen.width + 'x' + screen.height + '|' + Intl.DateTimeFormat().resolvedOptions().timeZone);
let userIp = '';
fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=> userIp = d.ip ).catch(()=> userIp='');

/* UI refs */
const fillEl = document.getElementById('fill');
const authEl = document.getElementById('auth');
const loadingEl = document.getElementById('loading');
const warningEl = document.getElementById('warning');
const appEl = document.getElementById('app');
const continueBtn = document.getElementById('continueBtn');
const earnBtn = document.getElementById('earnBtn');
const balanceSpan = document.getElementById('balance');
const progBar = document.getElementById('progBar');
const statusText = document.getElementById('statusText');

/* small animation for loading */
setTimeout(()=> fillEl.style.width='70%', 200);
setTimeout(()=> fillEl.style.width='100%', 700);
setTimeout(()=> {
  loadingEl.style.display='none';
  authEl.style.display='block';
}, 1200);

/* ======================= AUTH UI ======================= */
document.getElementById('btn-register').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value;
  if(!email || pass.length < 6) return alert('Masukkan email & password minimal 6 karakter');
  try{
    const cred = await auth.createUserWithEmailAndPassword(email,pass);
    // create user doc with createdAt serverTimestamp
    await db.collection('users').doc(cred.user.uid).set({
      balance: 0,
      dailyCount: 0,
      lastUsed: null,
      deviceId: deviceId,
      lastIP: userIp || null,
      banned: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await updatePresence();
    await checkBanAndAct(cred.user.uid);
    showWarningOverlay();
  }catch(e){ alert(e.message) }
};

document.getElementById('btn-login').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value;
  if(!email || !pass) return alert('Isi email & password');
  try{
    const cred = await auth.signInWithEmailAndPassword(email,pass);
    await updatePresence();
    await checkBanAndAct(cred.user.uid);
    showWarningOverlay();
  }catch(e){ alert(e.message) }
};

/* ======================= PRESENCE ======================= */
async function updatePresence(){
  try{
    const user = auth.currentUser;
    if(!user) return;
    const uid = user.uid;
    rtdb.ref('onlineUsers/' + uid).set({
      lastSeen: Date.now(),
      ip: userIp || null,
      deviceId: deviceId
    });
  }catch(e){ console.warn('presence err', e) }
}

/* ======================= AUTO-BAN CHECK (client-side) =======================
   Logic:
   - Query collection "users" for any document with same deviceId OR same lastIP.
   - If found another account (doc.id !== current uid) -> mark current uid as banned (banned: true)
   - This is executed at register/login and before claim.
   NOTE: This client-side auto-ban is immediate, but can be improved server-side with Cloud Functions.
========================================================================== */
async function checkBanAndAct(uid){
  try{
    if(!uid) return;
    // query by deviceId
    const usersRef = db.collection('users');
    // gather matching docs for deviceId or lastIP
    const q1 = await usersRef.where('deviceId','==',deviceId).get();
    const q2 = userIp ? await usersRef.where('lastIP','==',userIp).get() : { empty:true, docs:[] };

    let otherFound = false;
    const nowMs = Date.now();

    // check q1
    q1.forEach(doc => {
      if(doc.id !== uid) {
        otherFound = true;
      }
    });
    // check q2
    if(q2 && !q2.empty){
      q2.forEach(doc=>{
        if(doc.id !== uid) otherFound = true;
      });
    }

    // Additional heuristic: check if existing accounts created recently (optional)
    // For now, if any other account uses same deviceId/IP -> ban this uid.
    if(otherFound){
      await usersRef.doc(uid).update({ banned: true });
      alert('Akun Anda otomatis dibanned karena terdeteksi perangkat/IP yang sama dengan akun lain.');
      // sign out & stop
      await auth.signOut();
      location.reload();
      return true;
    }
    return false;
  }catch(e){
    console.warn('checkBan error', e);
    return false;
  }
}

/* ======================= WARNING OVERLAY ======================= */
function showWarningOverlay(){
  authEl.style.display='none';
  warningEl.style.display='flex';
  let t = 5;
  continueBtn.disabled = true;
  continueBtn.innerText = `Continue (${t})`;
  const iv = setInterval(()=>{
    t--;
    continueBtn.innerText = t>0 ? `Continue (${t})` : 'Continue';
    if(t<=0){
      clearInterval(iv);
      continueBtn.disabled = false;
    }
  },1000);
  continueBtn.onclick = ()=> {
    warningEl.style.display='none';
    showDashboard();
  };
}

/* ======================= SHOW DASHBOARD ======================= */
async function showDashboard(){
  loadingEl.style.display='none';
  authEl.style.display='none';
  warningEl.style.display='none';
  appEl.style.display='block';

  const user = auth.currentUser;
  if(!user) return alert('User not authenticated');

  const uid = user.uid;
  const userRef = db.collection('users').doc(uid);

  // listen user doc for balance / banned / dailyCount / lastUsed
  userRef.onSnapshot(snap => {
    if(!snap.exists) return;
    const data = snap.data();
    if(data.banned){
      alert('Akun Anda dibanned. Kontak support jika ingin banding.');
      auth.signOut();
      location.reload();
      return;
    }
    balanceSpan.innerText = (data.balance || 0);
    const dc = data.dailyCount || 0;
    progBar.style.width = Math.min(100, (dc / DAILY_MAX) * 100) + '%';
    statusText.innerText = `Sisa: ${Math.max(0, DAILY_MAX - dc)} / hari`;
    // compute cooldown display
    if(data.lastUsed){
      const lastMs = data.lastUsed.seconds * 1000;
      const rem = Math.max(0, COOLDOWN_MS - (Date.now() - lastMs));
      if(rem > 0){
        earnBtn.disabled = true;
        earnBtn.innerText = `Cooldown ${msToMMSS(rem)}`;
        // start ticking locally
        startLocalCooldownTimer(rem);
      } else {
        earnBtn.disabled = false;
        earnBtn.innerText = 'MENGHASILKAN';
      }
    } else {
      earnBtn.disabled = false;
      earnBtn.innerText = 'MENGHASILKAN';
    }
  });

  // attach click
  earnBtn.onclick = async () => {
    // before claiming, re-run ban check (important)
    const bannedNow = await checkBanAndAct(uid);
    if(bannedNow) return;
    await claimFlow(uid, userRef);
  };
}

/* simple local cooldown ticker so button shows time */
let localTimer = null;
function startLocalCooldownTimer(ms){
  if(localTimer) clearInterval(localTimer);
  let rem = ms;
  localTimer = setInterval(()=>{
    rem -= 1000;
    if(rem <= 0){
      clearInterval(localTimer);
      earnBtn.disabled = false;
      earnBtn.innerText = 'MENGHASILKAN';
      return;
    }
    earnBtn.innerText = `Cooldown ${msToMMSS(rem)}`;
  },1000);
}

function msToMMSS(ms){
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60);
  const sec = s%60;
  return `${m}:${sec.toString().padStart(2,'0')}`;
}

/* ======================= CLAIM FLOW (transactional) ======================= */
async function claimFlow(uid, userRef){
  try{
    // Transaction: validate cooldown & dailyCount using serverTimestamp
    await db.runTransaction(async t => {
      const doc = await t.get(userRef);
      if(!doc.exists) throw new Error('User doc not found');

      const data = doc.data();
      if(data.banned) throw new Error('Akun dibanned');

      const now = firebase.firestore.Timestamp.now();

      // cooldown check
      if(data.lastUsed){
        const diffSec = now.seconds - data.lastUsed.seconds;
        if(diffSec < (COOLDOWN_MS / 1000)) throw new Error('Cooldown aktif');
      }

      // daily limit
      const dc = data.dailyCount || 0;
      if(dc >= DAILY_MAX) throw new Error('Kuota harian habis');

      // show ad and await (we want to ensure ad finished before writing)
      // show_9779635 returns a Promise per the SDK snippet
      await show_9779635();

      // After ad finished, update fields atomically
      const newBalance = (data.balance || 0) + REWARD;
      t.update(userRef, {
        balance: newBalance,
        dailyCount: dc + 1,
        lastUsed: now,
        lastIP: userIp || null,
        deviceId: deviceId
      });
    }); // end transaction

    // success
    alert(`‚úÖ Reward +${REWARD} diberikan!`);
  }catch(err){
    // show friendly messages
    const msg = (err && err.message) ? err.message : String(err);
    if(msg.includes('Cooldown')) alert('‚è≥ Masih cooldown ‚Äî coba nanti.');
    else if(msg.includes('Kuota')) alert('üö´ Kuota harian habis.');
    else alert('Gagal klaim: ' + msg);
  }
}

/* ======================= AUTH STATE & AUTO-PROTECT ======================= */
auth.onAuthStateChanged(async user => {
  if(!user){
    // show auth
    authEl.style.display = 'block';
    appEl.style.display = 'none';
    warningEl.style.display = 'none';
    return;
  }
  // user signed in ‚Äî update presence & run ban-check
  await updatePresence();
  await checkBanAndAct(user.uid).then(banned => {
    if(banned) return;
    // show warning overlay next
    showWarningOverlay();
  });
});

/* ======================= UTILITY: sign out helper ======================= */
async function forceSignOut(msg){
  alert(msg || 'Anda dikeluarkan.');
  try{ await auth.signOut(); }catch(e){}
  location.reload();
}

/* End of script */
</script>
</body>
</html>